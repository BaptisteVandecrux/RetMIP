"0","multiplot <- function (models,var_name,clab_text,i_site,set_lim,offset,multipl_fact){"
"0","  if(missing(offset)) {"
"0","    offset<-0"
"0","  }"
"0","  if(missing(multipl_fact)) {"
"0","    multipl_fact<-1"
"0","  }"
"0","  # === Loading data ==="
"0","  for (i_mod in 1:9){"
"0","    file_name_col <- paste('RetMIP_',models[i_mod],'_',sites[i_site],'_3hourly_columns.nc',sep = """")"
"0","    path_file_col<-paste(path_model,models[i_mod],'/',file_name_col,sep = """")"
"0","    "
"0","    # loading column data"
"0","    file_nc_col<- nc_open(path_file_col)"
"0","    var_mod <- ncvar_get(file_nc_col, varid=var_name)"
"0","    var_mod <- var_mod + offset"
"0","    var_mod <- var_mod *multipl_fact"
"0","    "
"0","    if (i_mod == 6)"
"0","      {var_mod <- var_mod[!is.na(var_mod[,1]),]}"
"0","    # if (i_mod == 5 & var_name == ""temp"")"
"0","    # {var_mod <- var_mod +273}"
"0","    "
"0","    if (i_mod == 5 & var_name == ""lwc"")"
"0","      { var_mod<- pmax(var_mod,0)}"
"0","    # {var_mod <- var_mod +273}"
"0","    "
"0","    if (i_mod %in% 1:3 & var_name == ""lwc"")"
"0","      { var_mod<- var_mod*1000}"
"0","    "
"0","    if (dim(var_mod)[1]>dim(var_mod)[2]) var_mod <- t(var_mod)"
"0","    "
"0","    time1<-1:dim(var_mod)[2]"
"0","    "
"0","    date_mod<-seq(lubridate::dmy_hms(start_time[i_site]),"
"0","      lubridate::dmy_hms(end_time[i_site]),"
"0","      3600*3)"
"0","    "
"0","    if (length(date_mod)<length(time1)) {"
"0","      var_mod<-var_mod[,- (1:(length(time1)-length(date_mod)))]"
"0","      time1  <- time1[- (1:(length(time1)-length(date_mod)))]}"
"0","    "
"0","    if (length(date_mod)>length(time1)) {"
"0","      print(length(date_mod))"
"0","      print(length(time1))"
"0","      # print(date_mod[length(date_mod)])"
"0","      time <- ncvar_get(file_nc_col, varid='time')"
"0","      time<- time*3600*24 + as.POSIXct(""1900-01-01"")"
"0","      # print(time[1])"
"0","      # print(length(time))"
"0","      # print(time[length(time)])"
"0","    }"
"0","    while (length(date_mod)>length(time1)) {"
"0","      time1 <- append(time1, time1[length(time1)]+3600*3)"
"0","      var_mod <- cbind(var_mod, var_mod[,length(time1)-1])}"
"0","    # some filtering"
"0","    # var_mod<-var_mod[apply(var_mod, 1, Compose(is.finite, all)),]"
"0","    # rearranging in xyz array"
"0","    ind_select<-seq(1,dim(var_mod)[2],max(1,floor(dim(var_mod)[2]/1000)))"
"0","    time_select <- date_mod[ind_select]"
"0","    var_mod<-var_mod[,ind_select]"
"0","    var_mod_save<-var_mod"
"0","    var_mod<-melt(var_mod)"
"0","    df <- if (i_mod==1) {data.frame(var_mod)} else {cbind(df,var_mod$value)}"
"0","    colnames(df)[2+i_mod] <- paste(""val"",toString(i_mod),sep = """")"
"0","  }"
"0","  df$X1<--df$X1"
"0","  df$date <- time_select[df$X2]"
"0","  print(""Data loaded"")"
"0","  "
"0","  # === plotting ==="
"0","  print(""Plotting..."")"
"0","  pList <- lapply(1:length(models), function(i_mod){"
"0","    p <- ggplot(data = df,"
"0","          aes_string(x = ""date"", y = ""X1"", fill = paste(""val"",i_mod,sep=""""))) +"
"0","        geom_tile()+"
"0","        scale_y_continuous(breaks=c(0,-50,-100,-150,-200),"
"0","          labels=c(""0"", ""5"", ""10"",""15"",""20""),"
"0","          expand=c(0.02,0.01),"
"0","          limits=if (var_name == ""lwc"") {c(-70, 0 )} else {c(-200,0)})+"
"0","        scale_x_datetime(expand=c(0.02,0.01))+"
"0","        scale_fill_gradientn(name=clab_text,"
"0","          colours = if (var_name == ""rho"") "
"0","            {brewer.pal(length(models),""YlGnBu"")}"
"0","          else if (var_name == ""temp"")"
"0","            {rev(brewer.pal(length(models),""RdBu""))}"
"0","          else if (var_name == ""lwc"") "
"0","            {brewer.pal(length(models),""PuBu"")},"
"0","          limits = set_lim)+"
"0","        annotate('text', x = df$date[floor(length(df$date)/2)],"
"0","          y = if (var_name == ""lwc"") {-55} else {-180},"
"0","          label = models[i_mod],fontface=2)+"
"0","        theme(legend.position = if (i_mod==3) {c(1.05,0.9)} else {""none""},"
"0","          legend.justification = c(0,1),"
"0","          plot.margin=margin(0,10,10,0),"
"0","          axis.title.x = element_blank(),"
"0","          axis.text.x = if (i_mod %in% 7:9) {element_text(angle=90)} else {element_blank()},"
"0","          axis.title.y = element_blank(),"
"0","          axis.text.y = if (i_mod %in% c(1,4,7)) {element_text()} else {element_blank()},"
"0","          panel.background = element_blank(),"
"0","          axis.line = element_line(colour = ""black""),"
"0","          panel.border = element_rect(colour = ""black"", fill=NA, size=1))"
"0","  })"
"0","  "
"0","  p_final <- grid.arrange(grobs=pList, nrow=3,"
"0","    top=sites[[i_site]],"
"0","    left=""Depth (m)"","
"0","    bottom=""Date"","
"0","    right="" "","
"0","    vp=viewport(x=0, just=""left"", width=0.8, height=1),"
"0","    heights=unit(c(3.2,3.2,3.9), c(""cm"",""cm"", ""cm"")))"
"0","  print(""Saving..."")"
"0","  ggsave(filename=paste0(""Plots/"",sites[[i_site]],""_"",var_name,""_2D.jpg""),plot=p_final,device = ""jpeg"")"
"0","}"
