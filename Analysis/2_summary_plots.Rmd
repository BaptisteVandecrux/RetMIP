---
title: "RetMIP results"
output:
  html_document:
    highlight: textmate
    theme: spacelab
    toc: yes
  pdf_document:
    toc: yes
  html_notebook:
    toc: yes
  word_document:
    toc: yes
always_allow_html: yes
mathjax: null
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ncdf4)
library(ggplot2)
library(reshape)
library(functional)
library(pracma)
library(dplyr)
library(lubridate)
library(gridExtra)
library(grid)
library(viridis)
library(RColorBrewer)

path_model<-'C:/Users/bav/OneDrive - Geological survey of Denmark and Greenland/Data/RetMIP/Model outputs/'
sites<-list('KANU','Dye-2_long','Dye-2_16','Summit','FA')
models <- list('CFM-Cr','CFM-KM','DTU','DMIHH','GEUS','IMAUFDM','MeyerHewitt','UppsalaUniBucket','UppsalaUniDeepPerc')
start_time <- c("01-May-2012 00:00:00","01-Jun-1998 00:00:00","02-May-2016 00:00:00","02-Jul-2000 00:00:00","12-Apr-2014 00:00:00")
end_time <- c("31-Dec-2016 06:00:00","02-May-2015 15:00:00","28-Oct-2016 09:00:00","08-Mar-2015 12:00:00","02-Dec-2014 21:00:00")
```

This document contains the scripts and plots for the RetMIP project (http://retain.geus.dk/index.php/retmip/).



```{r multiplot 1D}
# ==== Plotting 1D ====

multi_1D_plot <- function (i_site,i_mod, var_name, set_lim, multipl_fact,opt,pal_name){
  
  if(missing(multipl_fact)) {
        multipl_fact<-1
  }
  if(missing(pal_name)) {
        pal_name<-'Set1'
  }
  if(missing(opt)) {
        opt<-"normal"
    }
  for (ii in i_mod){
    file_name_val <- paste('RetMIP_',models[ii],'_',sites[i_site],'_3hourly_values.nc',sep = "")
    path_file_val <- paste(path_model,models[ii],'/',file_name_val,sep = "")
    # print(file_name_val)
    file_nc_val<- nc_open(path_file_val)
  
    
  # extracting variable
    var_mod   <- ncvar_get(file_nc_val, varid = var_name)
      #Remove NA values
  var_mod <- var_mod[!is.na(var_mod)]
  var_mod <- var_mod*multipl_fact
  
  if (var_name %in% c("trfrz", "tlwc","trunoff")){
    if (models[ii] %in% c("CFM-Cr","CFM-KM","GEUS")) {
      var_mod <- var_mod * 1000
    }
  }
        if (strcmp(models[[ii]],"IMAUFDM")) {
    var_mod <- pmax(var_mod,0)}

  
    if(missing(set_lim)) {
          set_lim<- c(0,max(var_mod))
    }
  
  # reconstructing time
   # tryCatch(time1  <- ncvar_get(file_nc_val, varid = "time"), finally = time1  <- file_nc_val$dim$time$vals)
  nc_close(file_nc_val)

  # date_mod <- as.POSIXct("1900-01-01") + time_mod*3600*24
   time1<-1:length(var_mod)
    
    date_mod<-seq(lubridate::dmy_hms(start_time[i_site]),
                  lubridate::dmy_hms(end_time[i_site]),
                  3600*3)
    
  
    if (length(date_mod)<length(time1)) {
      var_mod<-var_mod[- (1:(length(time1)-length(date_mod)))]
      time1  <- time1[- (1:(length(time1)-length(date_mod)))]}
  

      while (length(date_mod)>length(time1)) {
      var_mod <- append(var_mod, NaN*var_mod[length(time1)-1])
      time1 <- append(time1, time1[length(time1)]+3600*3)}
    
  year_list <- unique(year(date_mod))
  
  if (is.null(colnames(df))) {
    df <- data.frame(date_mod,month(date_mod), year(date_mod))
      colnames(df)[2] <- "month"
      colnames(df)[3] <- "year"

  } 

  df[models[[ii]][1]] <- var_mod
  }
  
  df_m <- melt(df,id.vars = c(1,2,3))

  cbp1<-brewer.pal(9,pal_name)
                
# Plotting
if (opt=="normal"){

  
  pList <- lapply(1:length(year_list), function(i){ 
    p <- ggplot()+
      geom_line(data=df_m[(year(date_mod)==year_list[i] &
                                  month(date_mod) %in% 5:9),],
                aes(x = date_mod, 
                    y = value,
                    group = variable, 
                    color = variable))+
      labs(x = "", y = "")+
      scale_color_manual(values = cbp1)+
      scale_y_continuous(limits=set_lim,  expand=c(0.02,0.01))+
      scale_x_datetime(limits = as.POSIXct(c(paste(year_list[i],"-05-01",sep=""),
                                             paste(year_list[i],"-09-01",sep=""))) ,
                                           expand=c(0.02,0.01))+
      annotate('text', 
               x = as.POSIXct(paste(year_list[i],"-05-03",sep="")),
               y = 0.9*set_lim[2], 
               label = year_list[i],
               hjust=0)+
      labs(color="Model")+
      theme(axis.text.x = if (i<length(year_list)) {element_blank()} else {element_text(angle=90)},
            axis.title.x = element_blank(),
            axis.title.y = element_blank(),
            panel.background = element_blank(),
            axis.line = element_line(colour = "black"),
            panel.border = element_rect(colour = "black", fill=NA, size=1),
            legend.position = if (i==1){c(1.05,0.5)} else {"none"},
            legend.justification = c(0,1),
            legend.key=element_rect(colour=NA,fill=NA))
  })
  
 h_final<- grid.arrange(grobs=pList, 
               ncol=max(1,floor(length(year_list)/5)),
               top=sites[[i_site]], 
               left= if (var_name=="trfrz") {"Refreezing (mm w.eq.)"} else
             if (var_name=="tfac") {"Firn air content (m)"} else
               if (var_name=="trunoff") {"Runoff (mm w.eq.)"} else
                 if (var_name=="tlwc") {"Liquid water content (mm w.eq.)"},
               bottom="Month",
               vp=viewport(x=0, just="left", width=0.7, height=1))
  ggsave(filename=paste0("Plots/",sites[[i_site]],"_",var_name,"_",
                             paste(models[i_mod],collapse='_'),"_yby.jpg"),
             plot=h_final, device = "jpeg")
}

if (opt=="yearly"){
  
    #Yearly totals:
    df_year <- data.frame(unique(df$year))
    colnames(df_year)[1] <- "year"

    for (i in i_mod){
      df_year[,models[[i]][1]] <- accumarray(df$year-df$year[1]+1,df[,models[[i]][1]],func=function (x) {sum(x,na.rm=TRUE)}) }
  
      # for (i in i_mod){print(models[[i]][1])}

    df_year_m <- melt(df_year,id.vars = 1)
    h_yearly<- ggplot(data = df_year_m, 
                      aes(x=year,
                          y = value, 
                          group = variable, 
                          color=variable))+
      ggtitle(sites[[i_site]])+
      geom_point(size=2)+
      geom_line() +
      labs(x = "Year", 
           y =  if (var_name=="trfrz") {"Yearly refreezing (mm w.eq.)"} else
             if (var_name=="tfac") {"Yearly firn air content (m)"} else
               if (var_name=="trunoff") {"Yearly runoff (mm w.eq.)"} else
                 if (var_name=="tlwc") {"Yearly liquid water content (mm w.eq.)"},
           color="Model")+
      scale_color_manual(values = cbp1)+
      scale_x_continuous(expand=c(0.01,0.01))+
      scale_y_continuous(expand=c(0.01,0.01))+
      theme(panel.background = element_blank(),
              axis.line = element_line(colour = "black"),
              panel.border = element_rect(colour = "black", fill=NA, size=1),
            legend.key=element_rect(colour=NA,fill=NA))
    plot(h_yearly)
    ggsave(filename=paste0("Plots/",sites[[i_site]],"_",var_name,"_",
                             paste(models[i_mod],collapse='_'),"_yearly.jpg"),
             plot=h_yearly,device = "jpeg")
}
  
  if (opt=="yearly_average"){
  
    #Yearly totals:
    df_year <- data.frame(unique(df$year))
    colnames(df_year)[1] <- "year"

    for (i in i_mod){
      df_year[,models[[i]][1]] <- accumarray(df$year-df$year[1]+1,df[,models[[i]][1]], func=function (x) {mean(x,na.rm=TRUE)}) }
  
      # for (i in i_mod){print(models[[i]][1])}

    df_year_m <- melt(df_year,id.vars = 1)
    h_yearly<- ggplot(data = df_year_m, 
                      aes(x=year,
                          y = value, 
                          group = variable, 
                          color=variable))+
      geom_point(size=2)+
      geom_line() +
      labs(x = "Year", 
           y = if (var_name=="trfrz") {"Annual average refreezing (mm w.eq.)"} else
             if (var_name=="tfac") {"Annual average firn air content (m)"} else
               if (var_name=="trunoff") {"Annual average runoff (mm w.eq.)"} else
                 if (var_name=="tlwc") {"Annual average liquid water content (mm w.eq.)"},
           color="Model")+
      scale_color_manual(values = cbp1)+
      scale_x_continuous(expand=c(0,0))+
      scale_y_continuous(expand=c(0,0),limits=set_lim)+
      ggtitle(sites[[i_site]])+
      theme(panel.background = element_blank(),
              axis.line = element_line(colour = "black"),
              panel.border = element_rect(colour = "black", fill=NA, size=1),
            legend.key=element_rect(colour=NA,fill=NA))
    plot(h_yearly)
      ggsave(filename=paste0("Plots/",sites[[i_site]],"_",var_name,"_",
                             paste(models[i_mod],collapse='_'),"_yearly.jpg"),
             plot=h_yearly,device = "jpeg")

}

if(opt=="all"){
  h_all<- ggplot()+geom_line(data=df_m,
                aes(x = date_mod, 
                    y = value,
                    group = variable, 
                    color=variable))+
          scale_color_manual(values = cbp1)
  plot(h_all)

}

}

```



```{r trunoff KANU yearly1}
multi_1D_plot(i_site=1,i_mod=c(1,2,3,4,5,6,7,8,9), 
              var_name = 'trunoff',  
              multipl_fact=1,
              opt="yearly",
              pal_name='Paired')  
```

No runoff at KANU for IMAU FDM, UppsalaUniBucket and UppsalaUniDeepPerc.

```{r trfrz KANU yearly}
multi_1D_plot(i_site=1,i_mod=1:9, var_name = 'trfrz',  multipl_fact=1,opt="yearly")  
```


```{r trunoff KANU yearbyyear1}
multi_1D_plot(i_site=1,i_mod=c(1,2,6), var_name = 'trunoff',  multipl_fact=1)  
```

```{r trunoff KANU yearbyyear2}
multi_1D_plot(i_site=1,i_mod=c(3,4), var_name = 'trunoff',  multipl_fact=1)  
```

No runoff at KANU in IMAUFDM, UppsalaUni

```{r trfrz KANU yearbyyear1}
multi_1D_plot(i_site=1,i_mod=1:3, var_name = 'trfrz',  multipl_fact=1)  
```

```{r trfrz KANU yearbyyear2}
multi_1D_plot(i_site=1,i_mod=c(4,6,9), var_name = 'trfrz',  multipl_fact=1)  
```

```{r trfrz KANU yearbyyear3}
multi_1D_plot(i_site=1,i_mod=c(5,7,8), var_name = 'trfrz',  multipl_fact=1)  
```

```{r trunoff Dye2 long yearly1}
multi_1D_plot(i_site=2,i_mod=c(1,2,3,4,6,9), var_name = 'trunoff',  multipl_fact=1,opt="yearly")  
```

 
No runoff at Dye 2 in IMAUFDM, UppsalaUniBucket and UppsalaUniDeepPerc.


```{r trfrz  Dye2 long yearly}
multi_1D_plot(i_site=2,i_mod=1:9, var_name = 'trfrz',  multipl_fact=1,opt="yearly")  
```

```{r trfrz Dye2 16 yearbyyear1}
multi_1D_plot(i_site=3,i_mod=1:3, var_name = 'trfrz',  multipl_fact=1)  
```

```{r trfrz Dye2 16 yearbyyear2}
multi_1D_plot(i_site=3,i_mod=c(4,6,9), var_name = 'trfrz',  multipl_fact=1)  
```

```{r trfrz Dye2 16 yearbyyear3}
multi_1D_plot(i_site=3,i_mod=c(5,7,8), var_name = 'trfrz',  multipl_fact=1)  
```


```{r trfrz  Summit yearly}
multi_1D_plot(i_site=4,i_mod=1:9, var_name = 'trfrz',  multipl_fact=1,opt="yearly")  
```

```{r trunoff Summit yearly}
multi_1D_plot(i_site=4,i_mod=1:9, var_name = 'trunoff',  multipl_fact=1,opt="yearly")  
```

```{r trfrz FA yearbyyear1}
multi_1D_plot(i_site=5,i_mod=1:3, var_name = 'trfrz',  multipl_fact=1)  
```

```{r trfrz FA yearbyyear2}
multi_1D_plot(i_site=5,i_mod=c(4,6,9), var_name = 'trfrz',  multipl_fact=1)  
```

```{r trfrz FA yearbyyear3}
multi_1D_plot(i_site=5,i_mod=c(7,8), var_name = 'trfrz',  multipl_fact=1)  
```

```{r trunoff FA yearbyyear1}
multi_1D_plot(i_site=5,i_mod=1:3, var_name = 'trunoff',  multipl_fact=1)  
```

```{r trunoff FA yearbyyear2}
multi_1D_plot(i_site=5,i_mod=1:4, var_name = 'trunoff',set_lim=c(0,2),  multipl_fact=1)  
```

```{r trunoff FA yearbyyear3}
multi_1D_plot(i_site=5,i_mod=c(5,7,8), var_name = 'trunoff', set_lim=c(0,0.1), multipl_fact=1)  
```

```{r tfac KANU yearbyyear}
multi_1D_plot(i_site=1,i_mod=1:9, var_name = 'tfac',  multipl_fact=1,set_lim=c(7,13))  
```

```{r tfac Dye2 yearbyyear}
multi_1D_plot(i_site=3,i_mod=1:9, var_name = 'tfac',  multipl_fact=1,set_lim=c(10,20))  
```

```{r tfac FA yearbyyear}
multi_1D_plot(i_site=5,i_mod=1:9, var_name = 'tfac',  multipl_fact=1,set_lim=c(4,10)) 

```

```{r tlwc KANU yearbyyear}
multi_1D_plot(i_site=1,i_mod=1:2, var_name = 'tlwc',  multipl_fact=1)  
```

```{r tlwc Dye2 yearbyyear}
multi_1D_plot(i_site=3,i_mod=3:4, var_name = 'tlwc',  set_lim = c(0,200),multipl_fact=1)  
```

```{r tlwc FA yearbyyear}
multi_1D_plot(i_site=5,i_mod=1:9, var_name = 'tlwc',  multipl_fact=1) 
```

```{r tfac  KANU yearly}
multi_1D_plot(i_site=1,i_mod=1:9, var_name = 'tfac',  
              multipl_fact=1, opt="yearly_average",
              set_lim = c(7,12))  
```

```{r tfac  Dye2 long yearly}
multi_1D_plot(i_site=2,i_mod=1:9, var_name = 'tfac',  
              multipl_fact=1, opt="yearly_average",
              set_lim = c(7,25))  
```

```{r tfac Summit yearly}
multi_1D_plot(i_site=4,i_mod=1:9, var_name = 'tfac',  
              multipl_fact=1, opt="yearly_average",
              set_lim = c(18,25))  
```

